{% assign media_json = shop.metafields.instagram_feed.media %}
{% assign media_items = media_json.value %}
{% assign settings_metafield = shop.metafields.instagram_feed.settings.value %}
{% assign feed_type = settings_metafield.feedType | default: 'slider' %}
{% assign on_click = settings_metafield.onClick | default: 'popup' %}
{% assign show_arrows = settings_metafield.showArrows | default: true %}
{% assign post_spacing = settings_metafield.postSpacing | default: 'medium' %}
{% assign border_radius = settings_metafield.borderRadius | default: 'medium' %}

{% comment %} Spacing values {% endcomment %}
{% if post_spacing == 'none' %}
  {% assign spacing_value = '0' %}
{% elsif post_spacing == 'small' %}
  {% assign spacing_value = '8' %}
{% elsif post_spacing == 'medium' %}
  {% assign spacing_value = '16' %}
{% else %}
  {% assign spacing_value = '24' %}
{% endif %}

{% comment %} Border radius values {% endcomment %}
{% if border_radius == 'none' %}
  {% assign radius_value = '0' %}
{% elsif border_radius == 'small' %}
  {% assign radius_value = '4px' %}
{% elsif border_radius == 'medium' %}
  {% assign radius_value = '8px' %}
{% else %}
  {% assign radius_value = '16px' %}
{% endif %}

{% comment %} Column settings {% endcomment %}
{% if feed_type == 'grid' %}
  {% assign desktop_cols = settings_metafield.gridDesktopColumns | default: 4 %}
  {% assign mobile_cols = settings_metafield.gridMobileColumns | default: 2 %}
{% else %}
  {% assign desktop_cols = settings_metafield.sliderDesktopColumns | default: 4 %}
  {% assign mobile_cols = settings_metafield.sliderMobileColumns | default: 2 %}
{% endif %}

{% if media_items %}
  <div class="instagram-feed-wrapper" data-feed-id="{{ block.id }}">
    {% if settings_metafield.title and settings_metafield.title != blank %}
      <h2
        class="instagram-feed-title"
        style="text-align: center; color: {{ settings_metafield.titleColor | default: '#000000' }}; margin-bottom: 10px;"
      >
        {{ settings_metafield.title }}
      </h2>
    {% endif %}

    {% if settings_metafield.subheading and settings_metafield.subheading != blank %}
      <p
        class="instagram-feed-subheading"
        style="text-align: center; color: {{ settings_metafield.subheadingColor | default: '#666666' }}; margin-bottom: 30px;"
      >
        {{ settings_metafield.subheading }}
      </p>
    {% endif %}

    <div class="instagram-feed-container instagram-feed-{{ feed_type }}" data-feed-type="{{ feed_type }}">
      {% if feed_type == 'slider' %}
        {% comment %} Slider Layout {% endcomment %}
        <div class="instagram-slider-wrapper">
          {% if show_arrows %}
            <button class="instagram-slider-arrow instagram-slider-prev" aria-label="Previous">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
          {% endif %}

          <div class="instagram-slider-track">
            {% for item in media_items limit: 12 %}
              <div class="instagram-slide" data-slide-index="{{ forloop.index0 }}">
                <div
                  class="instagram-feed-item"
                  data-media-id="{{ item.id }}"
                  data-media-url="{{ item.thumbnail }}"
                  data-permalink="{{ item.permalink }}"
                  data-caption="{{ item.caption }}"
                  data-products='{{ item.products | json }}'
                  data-username="{{ item.username }}"
                  style="border-radius: {{ radius_value }};"
                >
                  <img src="{{ item.thumbnail }}" alt="{{ item.caption }}" loading="lazy">

                  {% if item.products.size > 0 %}
                    <div class="instagram-product-badge">
                      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                      </svg>
                      <span>{{ item.products.size }}</span>
                    </div>
                  {% endif %}

                  <div class="instagram-feed-overlay">
                    <span class="instagram-icon">@{{ item.username }}</span>
                  </div>
                </div>

                {% if item.products.size > 0 and settings_metafield.showAttachedProducts %}
                  <div class="instagram-product-tags">
                    {% for product in item.products limit: 3 %}
                      <a href="/products/{{ product.handle }}" class="instagram-product-tag">
                        {{ product.title }}
                      </a>
                    {% endfor %}
                    {% if item.products.size > 3 %}
                      <span class="instagram-product-tag-more">
                        +{{ item.products.size | minus: 3 }} more
                      </span>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>

          {% if show_arrows %}
            <button class="instagram-slider-arrow instagram-slider-next" aria-label="Next">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          {% endif %}
        </div>
      {% else %}
        {% comment %} Grid Layout {% endcomment %}
        <div class="instagram-grid" style="gap: {{ spacing_value }}px;">
          {% for item in media_items limit: 12 %}
            <div class="instagram-grid-item">
              <div
                class="instagram-feed-item"
                data-media-id="{{ item.id }}"
                data-media-url="{{ item.thumbnail }}"
                data-permalink="{{ item.permalink }}"
                data-caption="{{ item.caption }}"
                data-products='{{ item.products | json }}'
                data-username="{{ item.username }}"
                style="border-radius: {{ radius_value }};"
              >
                <img src="{{ item.thumbnail }}" alt="{{ item.caption }}" loading="lazy">

                {% if item.products.size > 0 %}
                  <div class="instagram-product-badge">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                    </svg>
                    <span>{{ item.products.size }}</span>
                  </div>
                {% endif %}

                <div class="instagram-feed-overlay">
                  <span class="instagram-icon">@{{ item.username }}</span>
                </div>
              </div>

              {% if item.products.size > 0 and settings_metafield.showAttachedProducts %}
                <div class="instagram-product-tags">
                  {% for product in item.products limit: 3 %}
                    <a href="/products/{{ product.handle }}" class="instagram-product-tag">
                      {{ product.title }}
                    </a>
                  {% endfor %}
                  {% if item.products.size > 3 %}
                    <span class="instagram-product-tag-more">
                      +{{ item.products.size | minus: 3 }} more
                    </span>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    {% comment %} Popup Modal {% endcomment %}
    <div class="instagram-popup-modal" id="instagram-popup-{{ block.id }}" style="display: none;">
      <div class="instagram-popup-overlay"></div>
      <div class="instagram-popup-content">
        <button class="instagram-popup-close" aria-label="Close">&times;</button>
        <div class="instagram-popup-inner">
          <div class="instagram-popup-image">
            <img src="" alt="">
          </div>
          <div class="instagram-popup-info">
            <div class="instagram-popup-username"></div>
            <div class="instagram-popup-caption"></div>
            <div class="instagram-popup-products"></div>
            <a href="" target="_blank" class="instagram-popup-link">View on Instagram</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const feedId = '{{ block.id }}';
      const feedType = '{{ feed_type }}';
      const onClick = '{{ on_click }}';
      const desktopCols = {{ desktop_cols }};
      const mobileCols = {{ mobile_cols }};

      // Tracking
      const track = async (data) => {
        try {
          await fetch('/apps/instagram-feed-track/event', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
        } catch (e) {
          console.debug('Tracking error:', e);
        }
      };

      track({ type: 'view' });

      // Slider functionality
      if (feedType === 'slider') {
        const wrapper = document.querySelector(`[data-feed-id="${feedId}"] .instagram-slider-wrapper`);
        const track = wrapper.querySelector('.instagram-slider-track');
        const prevBtn = wrapper.querySelector('.instagram-slider-prev');
        const nextBtn = wrapper.querySelector('.instagram-slider-next');
        const slides = track.querySelectorAll('.instagram-slide');

        let currentIndex = 0;
        const isMobile = window.innerWidth <= 768;
        const slidesToShow = isMobile ? mobileCols : desktopCols;
        const totalSlides = slides.length;
        const maxIndex = Math.max(0, totalSlides - slidesToShow);

        function updateSlider() {
          const slideWidth = 100 / slidesToShow;
          const offset = -(currentIndex * slideWidth);
          track.style.transform = `translateX(${offset}%)`;

          if (prevBtn) prevBtn.disabled = currentIndex === 0;
          if (nextBtn) nextBtn.disabled = currentIndex >= maxIndex;
        }

        if (prevBtn) {
          prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
              currentIndex--;
              updateSlider();
            }
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener('click', () => {
            if (currentIndex < maxIndex) {
              currentIndex++;
              updateSlider();
            }
          });
        }

        updateSlider();

        window.addEventListener('resize', () => {
          const newIsMobile = window.innerWidth <= 768;
          const newSlidesToShow = newIsMobile ? mobileCols : desktopCols;
          if (newSlidesToShow !== slidesToShow) {
            location.reload();
          }
        });
      }

      // Popup functionality
      const modal = document.getElementById(`instagram-popup-${feedId}`);
      const closeBtn = modal.querySelector('.instagram-popup-close');
      const overlay = modal.querySelector('.instagram-popup-overlay');

      function openPopup(item) {
        const mediaUrl = item.dataset.mediaUrl;
        const permalink = item.dataset.permalink;
        const caption = item.dataset.caption || '';
        const username = item.dataset.username || 'Instagram';
        let products = [];

        try {
          products = JSON.parse(item.dataset.products || '[]');
        } catch (e) {
          products = [];
        }

        modal.querySelector('.instagram-popup-image img').src = mediaUrl;
        modal.querySelector('.instagram-popup-username').textContent = `@${username}`;
        modal.querySelector('.instagram-popup-caption').textContent = caption;
        modal.querySelector('.instagram-popup-link').href = permalink;

        const productsContainer = modal.querySelector('.instagram-popup-products');
        if (products && products.length > 0) {
          productsContainer.innerHTML = '<h4>Tagged Products</h4>' +
            products.map(p => `<a href="/products/${p.handle}" class="popup-product-tag">${p.title}</a>`).join('');
          productsContainer.style.display = 'block';
        } else {
          productsContainer.style.display = 'none';
        }

        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      }

      function closePopup() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }

      closeBtn.addEventListener('click', closePopup);
      overlay.addEventListener('click', closePopup);

      // Click handling
      document.querySelectorAll(`[data-feed-id="${feedId}"] .instagram-feed-item`).forEach((item) => {
        item.style.cursor = 'pointer';
        item.addEventListener('click', function (e) {
          e.preventDefault();

          track({
            type: 'click',
            mediaId: this.dataset.mediaId,
            mediaUrl: this.dataset.mediaUrl,
            permalink: this.dataset.permalink,
          });

          if (onClick === 'popup') {
            openPopup(this);
          } else {
            window.open(this.dataset.permalink, '_blank');
          }
        });
      });
    })();
  </script>

  <style>
    .instagram-feed-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .instagram-feed-title {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .instagram-feed-subheading {
      font-size: 16px;
      margin-bottom: 30px;
    }

    /* Grid Layout */
    .instagram-grid {
      display: grid;
      grid-template-columns: repeat({{ desktop_cols }}, 1fr);
    }

    .instagram-grid-item {
      position: relative;
    }

    /* Slider Layout */
    .instagram-slider-wrapper {
      position: relative;
      overflow: hidden;
    }

    .instagram-slider-track {
      display: flex;
      transition: transform 0.3s ease;
      gap: {{ spacing_value }}px;
    }

    .instagram-slide {
      flex: 0 0 calc(100% / {{ desktop_cols }} - {{ spacing_value }}px * ({{ desktop_cols }} - 1) / {{ desktop_cols }});
      min-width: 0;
    }

    .instagram-slider-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: {{ settings_metafield.arrowBackgroundColor | default: 'rgba(255, 255, 255, 0.9)' }};
      color: {{ settings_metafield.arrowColor | default: '#000' }};
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transition: all 0.2s ease;
    }

    .instagram-slider-arrow:hover {
      transform: translateY(-50%) scale(1.1);
    }

    .instagram-slider-arrow:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .instagram-slider-prev {
      left: 10px;
    }

    .instagram-slider-next {
      right: 10px;
    }

    /* Feed Items */
    .instagram-feed-item {
      position: relative;
      display: block;
      overflow: hidden;
      aspect-ratio: 1 / 1;
      background: #f5f5f5;
    }

    .instagram-feed-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .instagram-feed-item:hover img {
      transform: scale(1.05);
    }

    .instagram-feed-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }

    .instagram-feed-item:hover .instagram-feed-overlay {
      opacity: 1;
    }

    /* Product Badge */
    .instagram-product-badge {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: {{ settings_metafield.cardBadgeBackgroundColor | default: 'rgba(255, 255, 255, 0.95)' }};
      color: {{ settings_metafield.cardBadgeIconColor | default: '#000' }};
      padding: 6px 10px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      z-index: 2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .instagram-product-badge svg {
      width: 16px;
      height: 16px;
    }

    /* Product Tags */
    .instagram-product-tags {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .instagram-product-tag {
      display: inline-block;
      background: #f0f0f0;
      color: #333;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      text-decoration: none;
      transition: background 0.2s ease;
    }

    .instagram-product-tag:hover {
      background: #e0e0e0;
      color: #000;
    }

    .instagram-product-tag-more {
      display: inline-block;
      background: #e8e8e8;
      color: #666;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
    }

    /* Popup Modal */
    .instagram-popup-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
    }

    .instagram-popup-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
    }

    .instagram-popup-content {
      position: relative;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      margin: 5vh auto;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .instagram-popup-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 24px;
      cursor: pointer;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .instagram-popup-close:hover {
      background: rgba(0, 0, 0, 0.7);
    }

    .instagram-popup-inner {
      display: flex;
      flex-direction: row;
      max-height: 90vh;
    }

    .instagram-popup-image {
      flex: 0 0 60%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .instagram-popup-image img {
      width: 100%;
      height: auto;
      max-height: 90vh;
      object-fit: contain;
    }

    .instagram-popup-info {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      max-height: 90vh;
    }

    .instagram-popup-username {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #262626;
    }

    .instagram-popup-caption {
      font-size: 14px;
      line-height: 1.6;
      color: #262626;
      margin-bottom: 20px;
    }

    .instagram-popup-products {
      margin-bottom: 20px;
    }

    .instagram-popup-products h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .popup-product-tag {
      display: inline-block;
      background: #f0f0f0;
      color: #333;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      text-decoration: none;
      margin: 4px;
      transition: background 0.2s ease;
    }

    .popup-product-tag:hover {
      background: #e0e0e0;
    }

    .instagram-popup-link {
      display: inline-block;
      background: #0095f6;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.2s ease;
    }

    .instagram-popup-link:hover {
      background: #0081d8;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .instagram-grid {
        grid-template-columns: repeat({{ mobile_cols }}, 1fr);
      }

      .instagram-slide {
        flex: 0 0 calc(100% / {{ mobile_cols }} - {{ spacing_value }}px * ({{ mobile_cols }} - 1) / {{ mobile_cols }});
      }

      .instagram-popup-inner {
        flex-direction: column;
      }

      .instagram-popup-image {
        flex: none;
      }

      .instagram-popup-info {
        padding: 20px;
      }

      .instagram-slider-arrow {
        width: 32px;
        height: 32px;
      }

      .instagram-slider-prev {
        left: 5px;
      }

      .instagram-slider-next {
        right: 5px;
      }
    }
  </style>
{% else %}
  {% if request.design_mode %}
    <div style="padding: 40px 20px; background: #f4f4f4; text-align: center; border-radius: 8px;">
      <p style="font-size: 16px; color: #666; margin-bottom: 10px;">ðŸ“¸ Instagram Feed App</p>
      <p style="font-size: 14px; color: #999;">No media found. Please connect your Instagram account in the App Settings and click "Sync Now".</p>
    </div>
  {% endif %}
{% endif %}

{% schema %}
{
  "name": "Instagram Feed",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Follow us on Instagram",
      "info": "This setting is overridden by app settings"
    },
    {
      "type": "paragraph",
      "content": "All display settings are managed through the Instagram Feed App dashboard. Go to Apps > Instagram Feed to customize your feed."
    }
  ]
}
{% endschema %}
