{% assign media_json = shop.metafields.instagram_feed.media %}
{% assign media_items = media_json.value %}
{% assign settings_metafield = shop.metafields.instagram_feed.settings.value %}
{% assign feed_type = settings_metafield.feedType | default: 'slider' %}
{% assign on_click = settings_metafield.onClick | default: 'popup' %}
{% assign show_arrows = settings_metafield.showArrows | default: true %}
{% assign post_spacing = settings_metafield.postSpacing | default: 'medium' %}
{% assign border_radius = settings_metafield.borderRadius | default: 'medium' %}
{% assign max_items = settings_metafield.mediaLimit | default: 12 %}
{% assign tracking_url = shop.metafields.instagram_feed.tracking_url.value %}

{% comment %} Spacing values {% endcomment %}
{% if post_spacing == 'none' %}
  {% assign spacing_value = '0' %}
{% elsif post_spacing == 'small' %}
  {% assign spacing_value = '8' %}
{% elsif post_spacing == 'medium' %}
  {% assign spacing_value = '16' %}
{% else %}
  {% assign spacing_value = '24' %}
{% endif %}

{% comment %} Border radius values {% endcomment %}
{% if border_radius == 'none' %}
  {% assign radius_value = '0' %}
{% elsif border_radius == 'small' %}
  {% assign radius_value = '4px' %}
{% elsif border_radius == 'medium' %}
  {% assign radius_value = '8px' %}
{% else %}
  {% assign radius_value = '16px' %}
{% endif %}

{% comment %} Column settings {% endcomment %}
{% if feed_type == 'grid' %}
  {% assign desktop_cols = settings_metafield.gridDesktopColumns | default: 4 %}
  {% assign mobile_cols = settings_metafield.gridMobileColumns | default: 2 %}
{% else %}
  {% assign desktop_cols = settings_metafield.sliderDesktopColumns | default: 4 %}
  {% assign mobile_cols = settings_metafield.sliderMobileColumns | default: 2 %}
{% endif %}

{% if media_items %}
  <div class="instagram-feed-wrapper" data-feed-id="{{ block.id }}">
    {% if settings_metafield.title and settings_metafield.title != blank %}
      <h2
        class="instagram-feed-title"
        style="text-align: center; color: {{ settings_metafield.titleColor | default: '#000000' }}; margin-bottom: 10px;"
      >
        {{ settings_metafield.title }}
      </h2>
    {% endif %}

    {% if settings_metafield.subheading and settings_metafield.subheading != blank %}
      <p
        class="instagram-feed-subheading"
        style="text-align: center; color: {{ settings_metafield.subheadingColor | default: '#666666' }}; margin-bottom: 30px;"
      >
        {{ settings_metafield.subheading }}
      </p>
    {% endif %}

    <div class="instagram-feed-container instagram-feed-{{ feed_type }}" data-feed-type="{{ feed_type }}">
      {% if feed_type == 'slider' %}
        {% comment %} Slider Layout {% endcomment %}
        <div class="instagram-slider-wrapper">
          {% if show_arrows %}
            <button class="instagram-slider-arrow instagram-slider-prev" aria-label="Previous">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
          {% endif %}

          <div class="instagram-slider-track">
            {% for item in media_items limit: max_items %}
              <div class="instagram-slide" data-slide-index="{{ forloop.index0 }}">
                <div
                  class="instagram-feed-item"
                  data-media-id="{{ item.id }}"
                  data-media-url="{{ item.thumbnail }}"
                  data-permalink="{{ item.permalink }}"
                  data-caption="{{ item.caption }}"
                  data-products='{{ item.products | json }}'
                  data-username="{{ item.username }}"
                  data-has-carousel="{{ item.children.size | default: 0 }}"
                  data-children='{{ item.children | json }}'
                  style="border-radius: {{ radius_value }};"
                >
                  {%- comment -%} Always show just the first image in feed {%- endcomment -%}
                  {%- comment -%} Carousel slider will be in popup only {%- endcomment -%}
                  <img src="{{ item.thumbnail }}" alt="{{ item.caption }}" loading="lazy">

                  {% if item.children.size > 1 %}
                    <div class="instagram-carousel-indicator">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                      </svg>
                    </div>
                  {% endif %}

                  {% if item.products.size > 0 %}
                    <div class="instagram-product-badge">
                      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                      </svg>
                      <span>{{ item.products.size }}</span>
                    </div>
                  {% endif %}

                  <div class="instagram-feed-overlay">
                    <span class="instagram-icon">@{{ item.username }}</span>
                  </div>
                </div>

                {% if item.products.size > 0 and settings_metafield.showAttachedProducts %}
                  <div class="instagram-product-tags">
                    {% for product in item.products limit: 3 %}
                      <a href="/products/{{ product.handle }}" class="instagram-product-tag">
                        {{ product.title }}
                      </a>
                    {% endfor %}
                    {% if item.products.size > 3 %}
                      <span class="instagram-product-tag-more">
                        +{{ item.products.size | minus: 3 }} more
                      </span>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>

          {% if show_arrows %}
            <button class="instagram-slider-arrow instagram-slider-next" aria-label="Next">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          {% endif %}
        </div>
      {% else %}
        {% comment %} Grid Layout {% endcomment %}
        <div class="instagram-grid" style="gap: {{ spacing_value }}px;">
          {% for item in media_items limit: max_items %}
            <div class="instagram-grid-item">
              <div
                class="instagram-feed-item"
                data-media-id="{{ item.id }}"
                data-media-url="{{ item.thumbnail }}"
                data-permalink="{{ item.permalink }}"
                data-caption="{{ item.caption }}"
                data-products='{{ item.products | json }}'
                data-username="{{ item.username }}"
                data-has-carousel="{{ item.children.size | default: 0 }}"
                data-children='{{ item.children | json }}'
                style="border-radius: {{ radius_value }};"
              >
                {%- comment -%} Always show just the first image in feed {%- endcomment -%}
                {%- comment -%} Carousel slider will be in popup only {%- endcomment -%}
                <img src="{{ item.thumbnail }}" alt="{{ item.caption }}" loading="lazy">

                {% if item.children.size > 1 %}
                  <div class="instagram-carousel-indicator">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                      <rect x="3" y="3" width="7" height="7" rx="1"/>
                      <rect x="14" y="3" width="7" height="7" rx="1"/>
                      <rect x="3" y="14" width="7" height="7" rx="1"/>
                      <rect x="14" y="14" width="7" height="7" rx="1"/>
                    </svg>
                  </div>
                {% endif %}

                {% if item.products.size > 0 %}
                  <div class="instagram-product-badge">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                    </svg>
                    <span>{{ item.products.size }}</span>
                  </div>
                {% endif %}

                <div class="instagram-feed-overlay">
                  <span class="instagram-icon">@{{ item.username }}</span>
                </div>
              </div>

              {% if item.products.size > 0 and settings_metafield.showAttachedProducts %}
                <div class="instagram-product-tags">
                  {% for product in item.products limit: 3 %}
                    <a href="/products/{{ product.handle }}" class="instagram-product-tag">
                      {{ product.title }}
                    </a>
                  {% endfor %}
                  {% if item.products.size > 3 %}
                    <span class="instagram-product-tag-more">
                      +{{ item.products.size | minus: 3 }} more
                    </span>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    {% comment %} Popup Modal {% endcomment %}
    <div class="instagram-popup-modal" id="instagram-popup-{{ block.id }}" style="display: none;">
      <div class="instagram-popup-overlay"></div>
      <div class="instagram-popup-content">
        <button class="instagram-popup-close" aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <div class="instagram-popup-inner">
          <div class="instagram-popup-image">
            {%- comment -%} Single image (will be updated via JS) {%- endcomment -%}
            <img src="" alt="" class="popup-single-image">

            {%- comment -%} Carousel for multi-image posts (will be populated via JS) {%- endcomment -%}
            <div class="popup-carousel-container" style="display: none;">
              <div class="popup-carousel-track"></div>
              <div class="popup-carousel-dots"></div>
              <button class="popup-carousel-prev" aria-label="Previous">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
              </button>
              <button class="popup-carousel-next" aria-label="Next">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </div>
          <div class="instagram-popup-info">
            <div class="instagram-popup-username"></div>
            <div class="instagram-popup-caption"></div>
            <div class="instagram-popup-products"></div>
            <a href="" target="_blank" class="instagram-popup-link">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
              </svg>
              View on Instagram
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const feedId = '{{ block.id }}';
      const feedType = '{{ feed_type }}';
      const onClick = '{{ on_click }}';
      const desktopCols = {{ desktop_cols }};
      const mobileCols = {{ mobile_cols }};
      const shopDomain = {{ shop.permanent_domain | json }};
      const directTrackingUrl = {{ tracking_url | json }};
      const proxyCandidates = [
        '/apps/instagram-feed-track',
        '/a/instagram-feed-track',
      ];
      const proxyStorageKey = 'wallify_proxy_path';

      // Tracking
      const track = async (data) => {
        const params = new URLSearchParams();
        Object.entries(data || {}).forEach(([key, value]) => {
          if (value !== undefined && value !== null && value !== '') {
            params.set(key, String(value));
          }
        });

        const preferredProxy = sessionStorage.getItem(proxyStorageKey);
        const endpointCandidates = preferredProxy
          ? [preferredProxy, ...proxyCandidates.filter((p) => p !== preferredProxy)]
          : proxyCandidates;

        for (const endpoint of endpointCandidates) {
          const fallbackUrl = `${endpoint}?${params.toString()}`;

          try {
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
              keepalive: true,
            });

            if (response.ok) {
              sessionStorage.setItem(proxyStorageKey, endpoint);
              return;
            }

            const getResponse = await fetch(fallbackUrl, { method: 'GET', keepalive: true });
            if (getResponse.ok) {
              sessionStorage.setItem(proxyStorageKey, endpoint);
              return;
            }

            console.warn(`Tracking failed on ${endpoint} (POST ${response.status}, GET ${getResponse.status}).`);
          } catch (error) {
            console.debug(`Tracking failed on ${endpoint}:`, error);
          }
        }

        if (directTrackingUrl) {
          const directParams = new URLSearchParams(params);
          directParams.set('shop', shopDomain);
          const separator = directTrackingUrl.includes('?') ? '&' : '?';
          const directUrl = `${directTrackingUrl}${separator}${directParams.toString()}`;

          try {
            await fetch(directUrl, { method: 'GET', mode: 'no-cors', keepalive: true });
            return;
          } catch (directError) {
            console.debug('Direct tracking fallback failed:', directError);
          }
        }

        console.error('Tracking disabled: App Proxy endpoint is not reachable. Verify App Proxy config/deploy.');
      };

      track({ type: 'view' });

      // Slider functionality
      if (feedType === 'slider') {
        const wrapper = document.querySelector(`[data-feed-id="${feedId}"] .instagram-slider-wrapper`);
        const track = wrapper.querySelector('.instagram-slider-track');
        const prevBtn = wrapper.querySelector('.instagram-slider-prev');
        const nextBtn = wrapper.querySelector('.instagram-slider-next');
        const slides = track.querySelectorAll('.instagram-slide');

        let currentIndex = 0;
        const isMobile = window.innerWidth <= 768;
        const slidesToShow = isMobile ? mobileCols : desktopCols;
        const totalSlides = slides.length;
        const maxIndex = Math.max(0, totalSlides - slidesToShow);

        function updateSlider() {
          const slideWidth = 100 / slidesToShow;
          const offset = -(currentIndex * slideWidth);
          track.style.transform = `translateX(${offset}%)`;

          if (prevBtn) prevBtn.disabled = currentIndex === 0;
          if (nextBtn) nextBtn.disabled = currentIndex >= maxIndex;
        }

        if (prevBtn) {
          prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
              currentIndex = Math.max(0, currentIndex - slidesToShow);
              updateSlider();
            }
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener('click', () => {
            if (currentIndex < maxIndex) {
              currentIndex = Math.min(maxIndex, currentIndex + slidesToShow);
              updateSlider();
            }
          });
        }

        updateSlider();

        window.addEventListener('resize', () => {
          const newIsMobile = window.innerWidth <= 768;
          const newSlidesToShow = newIsMobile ? mobileCols : desktopCols;
          if (newSlidesToShow !== slidesToShow) {
            location.reload();
          }
        });
      }

      // Popup functionality
      const modal = document.getElementById(`instagram-popup-${feedId}`);
      const closeBtn = modal.querySelector('.instagram-popup-close');
      const overlay = modal.querySelector('.instagram-popup-overlay');

      function openPopup(item) {
        const mediaUrl = item.dataset.mediaUrl;
        const permalink = item.dataset.permalink;
        const caption = item.dataset.caption || '';
        const username = item.dataset.username || 'Instagram';
        let products = [];
        let children = [];

        try {
          products = JSON.parse(item.dataset.products || '[]');
        } catch (e) {
          products = [];
        }

        try {
          children = JSON.parse(item.dataset.children || '[]');
        } catch (e) {
          children = [];
        }

        // Update info section
        modal.querySelector('.instagram-popup-username').textContent = `@${username}`;
        modal.querySelector('.instagram-popup-caption').textContent = caption;
        modal.querySelector('.instagram-popup-link').href = permalink;

        const productsContainer = modal.querySelector('.instagram-popup-products');
        if (products && products.length > 0) {
          productsContainer.innerHTML = '<h4>Tagged Products</h4>' +
            products.map(p => `<a href="/products/${p.handle}" class="popup-product-tag">${p.title}</a>`).join('');
          productsContainer.style.display = 'block';
        } else {
          productsContainer.style.display = 'none';
        }

        // Handle carousel vs single image
        const singleImage = modal.querySelector('.popup-single-image');
        const carouselContainer = modal.querySelector('.popup-carousel-container');

        if (children && children.length > 0) {
          // Show carousel
          singleImage.style.display = 'none';
          carouselContainer.style.display = 'block';

          // Populate carousel
          const track = carouselContainer.querySelector('.popup-carousel-track');
          const dotsContainer = carouselContainer.querySelector('.popup-carousel-dots');

          track.innerHTML = children.map((child, idx) => `
            <div class="popup-carousel-slide">
              <img src="${child.thumbnail_url || child.media_url}" alt="${caption}">
            </div>
          `).join('');

          dotsContainer.innerHTML = children.map((_, idx) => `
            <span class="popup-carousel-dot ${idx === 0 ? 'active' : ''}"></span>
          `).join('');

          // Initialize carousel
          let currentSlide = 0;
          const slides = track.querySelectorAll('.popup-carousel-slide');
          const dots = dotsContainer.querySelectorAll('.popup-carousel-dot');

          function updatePopupCarousel() {
            track.style.transform = `translateX(-${currentSlide * 100}%)`;
            dots.forEach((dot, idx) => {
              dot.classList.toggle('active', idx === currentSlide);
            });
          }

          const prevBtn = carouselContainer.querySelector('.popup-carousel-prev');
          const nextBtn = carouselContainer.querySelector('.popup-carousel-next');

          prevBtn.onclick = (e) => {
            e.stopPropagation();
            currentSlide = Math.max(0, currentSlide - 1);
            updatePopupCarousel();
          };

          nextBtn.onclick = (e) => {
            e.stopPropagation();
            currentSlide = Math.min(slides.length - 1, currentSlide + 1);
            updatePopupCarousel();
          };

          dots.forEach((dot, idx) => {
            dot.onclick = (e) => {
              e.stopPropagation();
              currentSlide = idx;
              updatePopupCarousel();
            };
          });

          updatePopupCarousel();
        } else {
          // Show single image
          singleImage.style.display = 'block';
          carouselContainer.style.display = 'none';
          singleImage.src = mediaUrl;
        }

        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      }

      function closePopup() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }

      closeBtn.addEventListener('click', closePopup);
      overlay.addEventListener('click', closePopup);

      // Carousel Logic for Multi-Image Posts
      document.querySelectorAll(`[data-feed-id="${feedId}"] .instagram-carousel-container`).forEach((container) => {
        const track = container.querySelector('.instagram-carousel-track');
        const slides = container.querySelectorAll('.instagram-carousel-slide');
        const dots = container.querySelectorAll('.instagram-carousel-dot');
        const prevBtn = container.querySelector('.instagram-carousel-prev');
        const nextBtn = container.querySelector('.instagram-carousel-next');

        if (slides.length === 0) return;

        let currentSlide = 0;

        function updateCarousel() {
          track.style.transform = `translateX(-${currentSlide * 100}%)`;

          dots.forEach((dot, idx) => {
            dot.classList.toggle('active', idx === currentSlide);
          });
        }

        if (prevBtn) {
          prevBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            currentSlide = Math.max(0, currentSlide - 1);
            updateCarousel();
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            currentSlide = Math.min(slides.length - 1, currentSlide + 1);
            updateCarousel();
          });
        }

        dots.forEach((dot, idx) => {
          dot.addEventListener('click', (e) => {
            e.stopPropagation();
            currentSlide = idx;
            updateCarousel();
          });
        });

        // Initialize first dot as active
        updateCarousel();
      });

      // Click handling
      document.querySelectorAll(`[data-feed-id="${feedId}"] .instagram-feed-item`).forEach((item) => {
        item.style.cursor = 'pointer';
        item.addEventListener('click', function (e) {
          e.preventDefault();

          track({
            type: 'click',
            mediaId: this.dataset.mediaId,
            mediaUrl: this.dataset.mediaUrl,
            permalink: this.dataset.permalink,
          });

          if (onClick === 'popup') {
            openPopup(this);
          } else {
            window.open(this.dataset.permalink, '_blank');
          }
        });
      });
    })();
  </script>

  <style>
    .instagram-feed-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .instagram-feed-title {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .instagram-feed-subheading {
      font-size: 16px;
      margin-bottom: 30px;
    }

    /* Grid Layout */
    .instagram-grid {
      display: grid;
      grid-template-columns: repeat({{ desktop_cols }}, 1fr);
    }

    .instagram-grid-item {
      position: relative;
    }

    /* Slider Layout */
    .instagram-slider-wrapper {
      position: relative;
      overflow: hidden;
    }

    .instagram-slider-track {
      display: flex;
      transition: transform 0.3s ease;
      gap: {{ spacing_value }}px;
    }

    .instagram-slide {
      flex: 0 0 calc(100% / {{ desktop_cols }} - {{ spacing_value }}px * ({{ desktop_cols }} - 1) / {{ desktop_cols }});
      min-width: 0;
    }

    .instagram-slider-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: {{ settings_metafield.arrowBackgroundColor | default: 'rgba(255, 255, 255, 0.9)' }};
      color: {{ settings_metafield.arrowColor | default: '#000' }};
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transition: all 0.2s ease;
    }

    .instagram-slider-arrow:hover {
      transform: translateY(-50%) scale(1.1);
    }

    .instagram-slider-arrow:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .instagram-slider-prev {
      left: 10px;
    }

    .instagram-slider-next {
      right: 10px;
    }

    /* Feed Items */
    .instagram-feed-item {
      position: relative;
      display: block;
      overflow: hidden;
      aspect-ratio: 1 / 1;
      background: #f5f5f5;
    }

    .instagram-feed-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .instagram-feed-item:hover img {
      transform: scale(1.05);
    }

    /* Carousel Container for Multi-Image Posts */
    .instagram-carousel-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .instagram-carousel-track {
      display: flex;
      height: 100%;
      transition: transform 0.3s ease;
    }

    .instagram-carousel-slide {
      flex: 0 0 100%;
      width: 100%;
      height: 100%;
    }

    .instagram-carousel-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Carousel Dots */
    .instagram-carousel-dots {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 6px;
      z-index: 3;
    }

    .instagram-carousel-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .instagram-carousel-dot.active {
      background: white;
      width: 8px;
      height: 8px;
    }

    /* Carousel Navigation Arrows */
    .instagram-carousel-prev,
    .instagram-carousel-next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 3;
      transition: all 0.2s ease;
      opacity: 0;
    }

    .instagram-feed-item:hover .instagram-carousel-prev,
    .instagram-feed-item:hover .instagram-carousel-next {
      opacity: 1;
    }

    .instagram-carousel-prev:hover,
    .instagram-carousel-next:hover {
      background: white;
      transform: translateY(-50%) scale(1.1);
    }

    .instagram-carousel-prev {
      left: 8px;
    }

    .instagram-carousel-next {
      right: 8px;
    }

    .instagram-carousel-prev svg,
    .instagram-carousel-next svg {
      color: #333;
    }

    .instagram-feed-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }

    .instagram-feed-item:hover .instagram-feed-overlay {
      opacity: 1;
    }

    /* Product Badge */
    .instagram-product-badge {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: {{ settings_metafield.cardBadgeBackgroundColor | default: 'rgba(255, 255, 255, 0.95)' }};
      color: {{ settings_metafield.cardBadgeIconColor | default: '#000' }};
      padding: 6px 10px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      z-index: 2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .instagram-product-badge svg {
      width: 16px;
      height: 16px;
    }

    /* Product Tags */
    .instagram-product-tags {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .instagram-product-tag {
      display: inline-block;
      background: #f0f0f0;
      color: #333;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      text-decoration: none;
      transition: background 0.2s ease;
    }

    .instagram-product-tag:hover {
      background: #e0e0e0;
      color: #000;
    }

    .instagram-product-tag-more {
      display: inline-block;
      background: #e8e8e8;
      color: #666;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
    }

    /* Popup Modal */
    .instagram-popup-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
    }

    .instagram-popup-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
    }

    .instagram-popup-content {
      position: relative;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      margin: 5vh auto;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .instagram-popup-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255, 255, 255, 0.95);
      color: #262626;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .instagram-popup-close:hover {
      background: rgba(255, 255, 255, 1);
      transform: rotate(90deg) scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .instagram-popup-close:active {
      transform: rotate(90deg) scale(0.95);
    }

    .instagram-popup-inner {
      display: flex;
      flex-direction: row;
      max-height: 90vh;
    }

    .instagram-popup-image {
      flex: 0 0 60%;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .instagram-popup-image img {
      width: 100%;
      height: auto;
      max-height: 90vh;
      object-fit: contain;
    }

    /* Popup Carousel Styles */
    .popup-carousel-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .popup-carousel-track {
      display: flex;
      height: 100%;
      transition: transform 0.3s ease;
    }

    .popup-carousel-slide {
      flex: 0 0 100%;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .popup-carousel-slide img {
      width: 100%;
      height: auto;
      max-height: 90vh;
      object-fit: contain;
    }

    .popup-carousel-dots {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .popup-carousel-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .popup-carousel-dot.active {
      background: white;
      width: 10px;
      height: 10px;
    }

    .popup-carousel-prev,
    .popup-carousel-next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: all 0.2s ease;
    }

    .popup-carousel-prev:hover,
    .popup-carousel-next:hover {
      background: white;
      transform: translateY(-50%) scale(1.1);
    }

    .popup-carousel-prev {
      left: 20px;
    }

    .popup-carousel-next {
      right: 20px;
    }

    .popup-carousel-prev svg,
    .popup-carousel-next svg {
      color: #333;
    }

    /* Carousel indicator on feed items */
    .instagram-carousel-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 2;
      opacity: 0.9;
      filter: drop-shadow(0 1px 3px rgba(0,0,0,0.3));
    }

    .instagram-popup-info {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      max-height: 90vh;
    }

    .instagram-popup-username {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #262626;
    }

    .instagram-popup-caption {
      font-size: 14px;
      line-height: 1.6;
      color: #262626;
      margin-bottom: 20px;
    }

    .instagram-popup-products {
      margin-bottom: 20px;
    }

    .instagram-popup-products h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .popup-product-tag {
      display: inline-block;
      background: #f0f0f0;
      color: #333;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      text-decoration: none;
      margin: 4px;
      transition: background 0.2s ease;
    }

    .popup-product-tag:hover {
      background: #e0e0e0;
    }

    .instagram-popup-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(188, 24, 136, 0.25);
      margin-top: 10px;
    }

    .instagram-popup-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(188, 24, 136, 0.35);
      background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
      filter: brightness(1.1);
    }

    .instagram-popup-link:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(188, 24, 136, 0.25);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .instagram-grid {
        grid-template-columns: repeat({{ mobile_cols }}, 1fr);
      }

      .instagram-slide {
        flex: 0 0 calc(100% / {{ mobile_cols }} - {{ spacing_value }}px * ({{ mobile_cols }} - 1) / {{ mobile_cols }});
      }

      .instagram-popup-inner {
        flex-direction: column;
      }

      .instagram-popup-image {
        flex: none;
      }

      .instagram-popup-info {
        padding: 20px;
      }

      .instagram-slider-arrow {
        width: 32px;
        height: 32px;
      }

      .instagram-slider-prev {
        left: 5px;
      }

      .instagram-slider-next {
        right: 5px;
      }
    }
  </style>
{% else %}
  {% if request.design_mode %}
    <div style="padding: 40px 20px; background: #f4f4f4; text-align: center; border-radius: 8px;">
      <p style="font-size: 16px; color: #666; margin-bottom: 10px;">ðŸ“¸ Instagram Feed App</p>
      <p style="font-size: 14px; color: #999;">No media found. Please connect your Instagram account in the App Settings and click "Sync Now".</p>
    </div>
  {% endif %}
{% endif %}

{% schema %}
{
  "name": "Instagram Feed",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Follow us on Instagram",
      "info": "This setting is overridden by app settings"
    },
    {
      "type": "paragraph",
      "content": "All display settings are managed through the Instagram Feed App dashboard. Go to Apps > Instagram Feed to customize your feed."
    }
  ]
}
{% endschema %}
