{% assign media_json = shop.metafields.instagram_feed.media %}
{% assign widget_config_json = shop.metafields.instagram_feed.widget_config %}

{% if media_json %}
  {% assign media_items = media_json.value %}

  {% if widget_config_json %}
    {% assign config = widget_config_json.value %}
  {% else %}
    {% comment %} Default fallback config if no widget published {% endcomment %}
    {% assign config = block.settings %}
  {% endif %}

  {% comment %}
    Allow overriding config from theme editor if needed,
    but for now we prioritize App Builder config if exists
  {% endcomment %}

  <div class="instagram-feed-section" style="padding: 40px 0;">
    <div class="instagram-feed-container">
      {% if config.showTitle %}
        <h2 class="instagram-feed-heading">
          {{ config.sectionTitle | default: 'Follow us on Instagram' }}
        </h2>
      {% endif %}

      {% if config.description != blank %}
        <p class="instagram-feed-description">{{ config.description }}</p>
      {% endif %}

      <div
        class="instagram-feed-wrapper instagram-feed-{{ config.layout }}"
        style="
          --columns-desktop: {{ config.columnsDesktop | default: 4 }};
          --columns-mobile: {{ config.columnsMobile | default: 2 }};
          --gap: {{ config.gap | default: 10 }}px;
        "
      >
        {% assign limit = config.limit | default: 8 %}
        {% for item in media_items limit: limit %}
          <a href="{{ item.permalink }}" target="_blank" class="instagram-feed-item">
            <div class="instagram-feed-image-wrapper">
              <img src="{{ item.thumbnail }}" alt="{{ item.caption }}" loading="lazy" width="100%" height="auto">
              {% if config.overlay %}
                <div class="instagram-feed-overlay">
                  <span class="instagram-icon">@{{ item.username }}</span>
                </div>
              {% endif %}
            </div>
          </a>
        {% endfor %}
      </div>

      {% if config.showButton %}
        <div class="instagram-feed-footer">
          <a href="{{ config.buttonUrl }}" target="_blank" class="instagram-feed-btn">
            {{ config.buttonText }}
          </a>
        </div>
      {% endif %}
    </div>
  </div>

  <style>
    .instagram-feed-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .instagram-feed-heading {
      text-align: center;
      margin-bottom: 10px;
      font-size: 24px;
      font-weight: bold;
    }
    .instagram-feed-description {
      text-align: center;
      margin-bottom: 30px;
      color: #666;
    }

    .instagram-feed-wrapper {
      display: grid;
      gap: var(--gap);
    }

    /* GRID LAYOUT */
    .instagram-feed-grid {
      grid-template-columns: repeat(var(--columns-desktop), 1fr);
    }

    /* CAROUSEL LAYOUT */
    .instagram-feed-carousel {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      grid-template-columns: none; /* override grid */
      padding-bottom: 20px; /* space for scrollbar */
    }

    .instagram-feed-carousel .instagram-feed-item {
      flex: 0 0 calc(100% / var(--columns-desktop) - var(--gap));
      scroll-snap-align: start;
      min-width: calc(100% / var(--columns-desktop) - var(--gap));
    }

    .instagram-feed-image-wrapper {
      position: relative;
      display: block;
      overflow: hidden;
      aspect-ratio: 1 / 1;
      border-radius: 8px;
    }

    .instagram-feed-image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
      display: block;
    }
    .instagram-feed-item:hover img {
      transform: scale(1.05);
    }
    .instagram-feed-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      color: white;
      font-weight: bold;
    }
    .instagram-feed-item:hover .instagram-feed-overlay {
      opacity: 1;
    }

    .instagram-feed-footer {
      text-align: center;
      margin-top: 30px;
    }
    .instagram-feed-btn {
      display: inline-block;
      padding: 12px 24px;
      background: #000;
      color: #fff;
      text-decoration: 'none';
      border-radius: 4px;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .instagram-feed-grid {
        grid-template-columns: repeat(var(--columns-mobile), 1fr);
      }

      .instagram-feed-carousel .instagram-feed-item {
        flex: 0 0 calc(100% / var(--columns-mobile) - var(--gap));
        min-width: calc(100% / var(--columns-mobile) - var(--gap));
      }
    }
  </style>
{% else %}
  {% if request.design_mode %}
    <div style="padding: 40px; text-align: center; background: #f9f9f9;">
      <p><strong>Instagram Feed App</strong></p>
      <p>No media found. Please create and publish a widget in the App Dashboard.</p>
    </div>
  {% endif %}
{% endif %}

{% schema %}
{
  "name": "Instagram Feed",
  "target": "section",
  "settings": []
}
{% endschema %}
