{% assign media_json = shop.metafields.instagram_feed.media %}
{% assign media_items = media_json.value %}
{% assign settings_metafield = shop.metafields.instagram_feed.settings.value %}
{% assign feed_type = settings_metafield.feedType | default: 'slider' %}
{% assign on_click = settings_metafield.onClick | default: 'popup' %}
{% assign show_arrows = settings_metafield.showArrows | default: true %}
{% assign post_spacing = settings_metafield.postSpacing | default: 'medium' %}
{% assign border_radius = settings_metafield.borderRadius | default: 'medium' %}
{% assign tracking_url = shop.metafields.instagram_feed.tracking_url.value %}
{% assign profile_picture_url = shop.metafields.instagram_feed.profile_picture_url.value %}
{% assign clean_display_raw = settings_metafield.cleanDisplay %}
{% assign button_text = settings_metafield.buttonText | default: 'Open in Instagram' %}
{% assign show_author_profile_raw = settings_metafield.showAuthorProfile %}
{% if clean_display_raw == true or clean_display_raw == 'true' %}
  {% assign clean_display = true %}
{% else %}
  {% assign clean_display = false %}
{% endif %}
{% if show_author_profile_raw == false or show_author_profile_raw == 'false' %}
  {% assign show_author_profile = false %}
{% else %}
  {% assign show_author_profile = true %}
{% endif %}
{% assign button_url = 'https://instagram.com' %}
{% if media_items and media_items.size > 0 %}
  {% assign first_item = media_items.first %}
  {% if first_item.username and first_item.username != blank %}
    {% assign button_url = 'https://instagram.com/' | append: first_item.username %}
  {% elsif first_item.permalink and first_item.permalink != blank %}
    {% assign button_url = first_item.permalink %}
  {% endif %}
{% endif %}

{% comment %} Spacing values {% endcomment %}
{% if post_spacing == 'none' %}
  {% assign spacing_value = '0' %}
{% elsif post_spacing == 'small' %}
  {% assign spacing_value = '8' %}
{% elsif post_spacing == 'medium' %}
  {% assign spacing_value = '16' %}
{% else %}
  {% assign spacing_value = '24' %}
{% endif %}

{% comment %} Border radius values {% endcomment %}
{% if border_radius == 'none' %}
  {% assign radius_value = '0' %}
{% elsif border_radius == 'small' %}
  {% assign radius_value = '4px' %}
{% elsif border_radius == 'medium' %}
  {% assign radius_value = '8px' %}
{% else %}
  {% assign radius_value = '16px' %}
{% endif %}

{% comment %} Column settings {% endcomment %}
{% if feed_type == 'grid' %}
  {% assign desktop_cols = settings_metafield.gridDesktopColumns | default: 4 %}
  {% assign mobile_cols = settings_metafield.gridMobileColumns | default: 2 %}
{% else %}
  {% assign desktop_cols = settings_metafield.sliderDesktopColumns | default: 4 %}
  {% assign mobile_cols = settings_metafield.sliderMobileColumns | default: 2 %}
{% endif %}

{% if media_items %}
  <div
    class="instagram-feed-wrapper{% if clean_display %} instagram-feed-wrapper--clean{% endif %}"
    data-feed-id="{{ block.id }}"
    data-feed-type="{{ feed_type }}"
    data-on-click="{{ on_click }}"
    data-desktop-cols="{{ desktop_cols }}"
    data-mobile-cols="{{ mobile_cols }}"
    data-shop-domain="{{ shop.permanent_domain | escape }}"
    data-direct-tracking-url="{{ tracking_url | default: '' | escape }}"
    style="
      --if-desktop-cols: {{ desktop_cols }};
      --if-mobile-cols: {{ mobile_cols }};
      --if-spacing: {{ spacing_value }}px;
      --if-arrow-bg: {{ settings_metafield.arrowBackgroundColor | default: 'rgba(255, 255, 255, 0.9)' }};
      --if-arrow-color: {{ settings_metafield.arrowColor | default: '#000' }};
      --if-card-username-color: {{ settings_metafield.cardUserNameColor | default: '#ffffff' }};
      --if-card-badge-bg: {{ settings_metafield.cardBadgeBackgroundColor | default: 'rgba(255, 255, 255, 0.95)' }};
      --if-card-badge-icon-color: {{ settings_metafield.cardBadgeIconColor | default: '#000' }};
    "
  >
    {% if settings_metafield.title and settings_metafield.title != blank %}
      <h2
        class="instagram-feed-title"
        style="text-align: center; color: {{ settings_metafield.titleColor | default: '#000000' }}; margin-bottom: 10px;"
      >
        {{ settings_metafield.title }}
      </h2>
    {% endif %}

    {% if settings_metafield.subheading and settings_metafield.subheading != blank %}
      <p
        class="instagram-feed-subheading"
        style="text-align: center; color: {{ settings_metafield.subheadingColor | default: '#666666' }}; margin-bottom: 30px;"
      >
        {{ settings_metafield.subheading }}
      </p>
    {% endif %}

    <div class="instagram-feed-container instagram-feed-{{ feed_type }}" data-feed-type="{{ feed_type }}">
      {% if feed_type == 'slider' %}
        {% comment %} Slider Layout {% endcomment %}
        <div class="instagram-slider-wrapper">
          {% if show_arrows %}
            <button class="instagram-slider-arrow instagram-slider-prev" aria-label="Previous">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
          {% endif %}

          <div class="instagram-slider-track">
            {% for item in media_items %}
              <div class="instagram-slide" data-slide-index="{{ forloop.index0 }}">
                <div
                  class="instagram-feed-item"
                  data-media-id="{{ item.id }}"
                  data-media-url="{{ item.thumbnail }}"
                  data-video-url="{{ item.url }}"
                  data-media-type="{{ item.type }}"
                  data-permalink="{{ item.permalink }}"
                  data-caption="{{ item.caption }}"
                  data-products='{{ item.products | json }}'
                  data-username="{{ item.username }}"
                  data-has-carousel="{{ item.children.size | default: 0 }}"
                  data-children='{{ item.children | json }}'
                  style="border-radius: {{ radius_value }};"
                >
                  {% if item.type == 'VIDEO' or item.type == 'REEL' %}
                    <video src="{{ item.url }}" poster="{{ item.thumbnail }}" muted loop playsinline preload="none"></video>
                  {% else %}
                    <img src="{{ item.thumbnail }}" alt="{{ item.caption }}" loading="lazy">
                  {% endif %}

                  {% unless clean_display %}
                    {% if item.children.size > 1 %}
                      <div class="instagram-carousel-indicator">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                          <rect x="3" y="3" width="7" height="7" rx="1"/>
                          <rect x="14" y="3" width="7" height="7" rx="1"/>
                          <rect x="3" y="14" width="7" height="7" rx="1"/>
                          <rect x="14" y="14" width="7" height="7" rx="1"/>
                        </svg>
                      </div>
                    {% endif %}

                    {% if item.products.size > 0 %}
                      <div class="instagram-product-badge">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                        </svg>
                        <span>{{ item.products.size }}</span>
                      </div>
                    {% endif %}

                  {% endunless %}

                  {% if show_author_profile %}
                    <div class="instagram-feed-overlay">
                      <div class="instagram-feed-author">
                        {% if profile_picture_url %}
                          <img src="{{ profile_picture_url }}" alt="" class="instagram-feed-avatar">
                        {% endif %}
                        <span class="instagram-icon">@{{ item.username }}</span>
                      </div>
                    </div>
                  {% endif %}
                </div>

                {% unless clean_display %}
                  {% if item.products.size > 0 and settings_metafield.showAttachedProducts %}
                    <div class="instagram-product-tags">
                      {% for product in item.products limit: 3 %}
                        <a href="/products/{{ product.handle }}" class="instagram-product-tag">
                          {{ product.title }}
                        </a>
                      {% endfor %}
                      {% if item.products.size > 3 %}
                        <span class="instagram-product-tag-more">
                          +{{ item.products.size | minus: 3 }} more
                        </span>
                      {% endif %}
                    </div>
                  {% endif %}
                {% endunless %}
              </div>
            {% endfor %}
          </div>

          {% if show_arrows %}
            <button class="instagram-slider-arrow instagram-slider-next" aria-label="Next">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          {% endif %}
        </div>
      {% else %}
        {% comment %} Grid Layout {% endcomment %}
        <div class="instagram-grid">
          {% for item in media_items %}
            <div class="instagram-grid-item">
              <div
                class="instagram-feed-item"
                data-media-id="{{ item.id }}"
                data-media-url="{{ item.thumbnail }}"
                data-video-url="{{ item.url }}"
                data-media-type="{{ item.type }}"
                data-permalink="{{ item.permalink }}"
                data-caption="{{ item.caption }}"
                data-products='{{ item.products | json }}'
                data-username="{{ item.username }}"
                data-has-carousel="{{ item.children.size | default: 0 }}"
                data-children='{{ item.children | json }}'
                style="border-radius: {{ radius_value }};"
              >
                {% if item.type == 'VIDEO' or item.type == 'REEL' %}
                  <video src="{{ item.url }}" poster="{{ item.thumbnail }}" muted loop playsinline preload="none"></video>
                {% else %}
                  <img src="{{ item.thumbnail }}" alt="{{ item.caption }}" loading="lazy">
                {% endif %}

                {% unless clean_display %}
                  {% if item.children.size > 1 %}
                    <div class="instagram-carousel-indicator">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                      </svg>
                    </div>
                  {% endif %}

                  {% if item.products.size > 0 %}
                    <div class="instagram-product-badge">
                      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                      </svg>
                      <span>{{ item.products.size }}</span>
                    </div>
                  {% endif %}

                {% endunless %}

                {% if show_author_profile %}
                  <div class="instagram-feed-overlay">
                    <div class="instagram-feed-author">
                      {% if profile_picture_url %}
                        <img src="{{ profile_picture_url }}" alt="" class="instagram-feed-avatar">
                      {% endif %}
                      <span class="instagram-icon">@{{ item.username }}</span>
                    </div>
                  </div>
                {% endif %}
              </div>

              {% unless clean_display %}
                {% if item.products.size > 0 and settings_metafield.showAttachedProducts %}
                  <div class="instagram-product-tags">
                    {% for product in item.products limit: 3 %}
                      <a href="/products/{{ product.handle }}" class="instagram-product-tag">
                        {{ product.title }}
                      </a>
                    {% endfor %}
                    {% if item.products.size > 3 %}
                      <span class="instagram-product-tag-more">
                        +{{ item.products.size | minus: 3 }} more
                      </span>
                    {% endif %}
                  </div>
                {% endif %}
              {% endunless %}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    {% if button_text and button_text != blank %}
      <div class="instagram-feed-cta-wrap">
        <a href="{{ button_url }}" target="_blank" rel="noopener noreferrer" class="instagram-feed-cta">
          {{ button_text }}
        </a>
      </div>
    {% endif %}

    {% comment %} Popup Modal {% endcomment %}
    <div class="instagram-popup-modal {% if clean_display %}instagram-popup-clean{% endif %}" id="instagram-popup-{{ block.id }}" style="display: none;">
      <div class="instagram-popup-overlay"></div>
      {% if clean_display %}
        {%- comment -%} Clean display: lightbox style like app preview {%- endcomment -%}
        <button class="instagram-popup-close instagram-popup-close-clean" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <div class="instagram-popup-clean-inner">
          {% if show_author_profile %}
            <div class="instagram-popup-clean-user-header">
              {% if profile_picture_url %}
                <img src="{{ profile_picture_url }}" alt="" class="instagram-popup-avatar instagram-popup-avatar-clean">
              {% endif %}
              <div class="instagram-popup-username-clean"></div>
            </div>
          {% endif %}
          <div class="instagram-popup-clean-media">
            <img src="" alt="" class="popup-single-image">
            <video src="" class="popup-single-video" autoplay loop playsinline controls style="display: none;"></video>
            <div class="popup-carousel-container" style="display: none;">
              <div class="popup-carousel-track"></div>
              <div class="popup-carousel-dots"></div>
              <button class="popup-carousel-prev" aria-label="Previous">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
              </button>
              <button class="popup-carousel-next" aria-label="Next">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </div>
          <a href="" target="_blank" class="instagram-popup-link-clean">Open in Instagram</a>
        </div>
      {% else %}
        <div class="instagram-popup-content">
          <button class="instagram-popup-close" aria-label="Close">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
          <div class="instagram-popup-inner">
            <div class="instagram-popup-image">
              <img src="" alt="" class="popup-single-image">
              <video src="" class="popup-single-video" autoplay loop playsinline controls style="display: none;"></video>
              <div class="popup-carousel-container" style="display: none;">
                <div class="popup-carousel-track"></div>
                <div class="popup-carousel-dots"></div>
                <button class="popup-carousel-prev" aria-label="Previous">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                </button>
                <button class="popup-carousel-next" aria-label="Next">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </button>
              </div>
            </div>
            <div class="instagram-popup-info">
              <div class="instagram-popup-user-header">
                {% if profile_picture_url %}
                  <img src="{{ profile_picture_url }}" alt="" class="instagram-popup-avatar">
                {% endif %}
                <div class="instagram-popup-username"></div>
              </div>
              <div class="instagram-popup-caption"></div>
              <div class="instagram-popup-products"></div>
              <a href="" target="_blank" class="instagram-popup-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                  <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                </svg>
                View on Instagram
              </a>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

{% else %}
  {% if request.design_mode %}
    <div style="padding: 40px 20px; background: #f4f4f4; text-align: center; border-radius: 8px;">
      <p style="font-size: 16px; color: #666; margin-bottom: 10px;">ðŸ“¸ Instagram Feed App</p>
      <p style="font-size: 14px; color: #999;">No media found. Please connect your Instagram account in the App Settings and click "Sync Now".</p>
    </div>
  {% endif %}
{% endif %}

{% schema %}
{
  "name": "Instagram Feed",
  "target": "section",
  "stylesheet": "instagram-feed.css",
  "javascript": "instagram-feed.js",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Follow us on Instagram",
      "info": "This setting is overridden by app settings"
    },
    {
      "type": "paragraph",
      "content": "All display settings are managed through the Instagram Feed App dashboard. Go to Apps > Instagram Feed to customize your feed."
    }
  ]
}
{% endschema %}
