{% assign media_json = shop.metafields.instagram_feed.media %}
{% assign media_items = media_json.value %}
{% assign settings_metafield = shop.metafields.instagram_feed.settings.value %}
{% assign feed_type = settings_metafield.feedType | default: 'slider' %}

{% if feed_type == 'grid' %}
  {% assign desktop_cols = settings_metafield.gridDesktopColumns | default: block.settings.columns_desktop %}
  {% assign mobile_cols = settings_metafield.gridMobileColumns | default: block.settings.columns_mobile %}
{% else %}
  {% assign desktop_cols = settings_metafield.sliderDesktopColumns | default: block.settings.columns_desktop %}
  {% assign mobile_cols = settings_metafield.sliderMobileColumns | default: block.settings.columns_mobile %}
{% endif %}

{% if media_items %}
  <div class="instagram-feed-container" style="padding: {{ block.settings.padding }}px;">
    {% if block.settings.heading != blank %}
      <h2
        class="instagram-feed-heading"
        style="text-align: {{ block.settings.heading_alignment }}; color: {{ block.settings.heading_color }};"
      >
        {{ block.settings.heading }}
      </h2>
    {% endif %}

    <div
      class="instagram-feed-grid"
      style="
        display: grid;
        grid-template-columns: repeat({{ desktop_cols }}, 1fr);
        gap: {{ block.settings.grid_gap }}px;
      "
    >
      {% for item in media_items limit: block.settings.limit %}
        <div class="instagram-feed-item-wrapper">
          <a
            href="{{ item.permalink }}"
            target="_blank"
            class="instagram-feed-item"
            data-media-id="{{ item.id }}"
            data-media-url="{{ item.thumbnail }}"
            data-permalink="{{ item.permalink }}"
          >
            <img src="{{ item.thumbnail }}" alt="{{ item.caption }}" loading="lazy" width="100%" height="auto">

            {% comment %} Product badges overlay {% endcomment %}
            {% if item.products.size > 0 %}
              <div class="instagram-product-badge">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                </svg>
                <span>{{ item.products.size }}</span>
              </div>
            {% endif %}

            <div class="instagram-feed-overlay">
              <span class="instagram-icon">@{{ item.username }}</span>
            </div>
          </a>

          {% comment %} Product tags below image {% endcomment %}
          {% if item.products.size > 0 and settings_metafield.showAttachedProducts %}
            <div class="instagram-product-tags">
              {% for product in item.products limit: 3 %}
                <a href="/products/{{ product.handle }}" class="instagram-product-tag">
                  {{ product.title }}
                </a>
              {% endfor %}
              {% if item.products.size > 3 %}
                <span class="instagram-product-tag-more">
                  +{{ item.products.size | minus: 3 }} more
                </span>
              {% endif %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>

  <script>
    (function () {
      const track = async (data) => {
        try {
          await fetch('/apps/instagram-feed-track/event', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
        } catch (e) {
          // Silently fail in production
          console.debug('Tracking error:', e);
        }
      };

      // Track aggregate view for the shop
      track({ type: 'view' });

      // Track individual post clicks
      document.querySelectorAll('.instagram-feed-item').forEach((item) => {
        item.addEventListener('click', function () {
          track({
            type: 'click',
            mediaId: this.dataset.mediaId,
            mediaUrl: this.dataset.mediaUrl,
            permalink: this.dataset.permalink,
          });
        });
      });
    })();
  </script>

  <style>
    .instagram-feed-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .instagram-feed-heading {
      margin-bottom: 20px;
    }
    .instagram-feed-item-wrapper {
      position: relative;
    }
    .instagram-feed-item {
      position: relative;
      display: block;
      overflow: hidden;
      aspect-ratio: 1 / 1;
    }
    .instagram-feed-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    .instagram-feed-item:hover img {
      transform: scale(1.05);
    }
    .instagram-feed-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      color: white;
      font-weight: bold;
    }
    .instagram-feed-item:hover .instagram-feed-overlay {
      opacity: 1;
    }

    /* Product badge on image */
    .instagram-product-badge {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      color: #000;
      padding: 6px 10px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      z-index: 2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    .instagram-product-badge svg {
      width: 16px;
      height: 16px;
    }

    /* Product tags below image */
    .instagram-product-tags {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .instagram-product-tag {
      display: inline-block;
      background: #f0f0f0;
      color: #333;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      text-decoration: none;
      transition: background 0.2s ease;
    }
    .instagram-product-tag:hover {
      background: #e0e0e0;
      color: #000;
    }
    .instagram-product-tag-more {
      display: inline-block;
      background: #e8e8e8;
      color: #666;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
    }

    @media (max-width: 768px) {
      .instagram-feed-grid {
        grid-template-columns: repeat({{mobile_cols}}, 1fr) !important;
      }
      .instagram-product-badge {
        bottom: 6px;
        right: 6px;
        padding: 4px 8px;
        font-size: 11px;
      }
      .instagram-product-badge svg {
        width: 14px;
        height: 14px;
      }
    }
  </style>
{% else %}
  {% if request.design_mode %}
    <div style="padding: 20px; background: #f4f4f4; text-align: center;">
      <p>Instagram Feed App: No media found.</p>
      <p>Please connect your account in the App Settings and click "Sync Now".</p>
    </div>
  {% endif %}
{% endif %}

{% schema %}
{
  "name": "Instagram Feed",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Follow us on Instagram"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#000000"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 1,
      "max": 6,
      "step": 1,
      "label": "Columns (Desktop)",
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "min": 1,
      "max": 3,
      "step": 1,
      "label": "Columns (Mobile)",
      "default": 2
    },
    {
      "type": "range",
      "id": "limit",
      "min": 1,
      "max": 12,
      "step": 1,
      "label": "Max Items",
      "default": 8
    },
    {
      "type": "range",
      "id": "grid_gap",
      "min": 0,
      "max": 50,
      "step": 5,
      "label": "Grid Gap (px)",
      "default": 10
    },
    {
      "type": "range",
      "id": "padding",
      "min": 0,
      "max": 100,
      "step": 10,
      "label": "Section Padding (px)",
      "default": 40
    }
  ]
}
{% endschema %}
